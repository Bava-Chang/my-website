<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å·¥å» æ‰“å¡ç³»çµ±</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      max-width: 500px;
      width: 100%;
      animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: #667eea;
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .station-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px 25px;
      border-radius: 25px;
      font-size: 20px;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      color: #333;
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 16px;
    }
    
    .form-group input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .message {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 16px;
      text-align: center;
      animation: fadeIn 0.5s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
    }
    
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
    }
    
    .message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 2px solid #bee5eb;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .device-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #666;
    }
    
    .device-info strong {
      color: #333;
    }
    
    .success-icon {
      font-size: 60px;
      text-align: center;
      margin: 20px 0;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ­ å·¥å» æ‰“å¡ç³»çµ±</h1>
      <div class="station-badge" id="stationName">è¼‰å…¥ä¸­...</div>
    </div>
    
    <!-- è¼‰å…¥ä¸­ -->
    <div id="loadingScreen" class="loading">
      <div class="spinner"></div>
      <p style="margin-top: 15px; color: #666;">æ­£åœ¨è­˜åˆ¥è£ç½®...</p>
    </div>
    
    <!-- ç¶å®šè¡¨å–® -->
    <div id="bindingForm" class="hidden">
      <div class="message info">
        <strong>ğŸ” é¦–æ¬¡ä½¿ç”¨</strong><br>
        è«‹è¼¸å…¥æ‚¨çš„å·¥è™Ÿå’Œå§“åå®Œæˆç¶å®š
      </div>
      
      <div class="form-group">
        <label for="employeeId">å·¥è™Ÿ</label>
        <input type="text" id="employeeId" placeholder="è«‹è¼¸å…¥å·¥è™Ÿ" required>
      </div>
      
      <div class="form-group">
        <label for="employeeName">å§“å</label>
        <input type="text" id="employeeName" placeholder="è«‹è¼¸å…¥å§“å" required>
      </div>
      
      <button class="btn btn-primary" onclick="handleBind()">
        ç¶å®šä¸¦æ‰“å¡
      </button>
      
      <div class="device-info">
        <strong>è£ç½®è³‡è¨Šï¼š</strong><br>
        è£ç½®IDï¼š<span id="deviceIdDisplay">-</span>
      </div>
    </div>
    
    <!-- æ‰“å¡æˆåŠŸ -->
    <div id="checkinSuccess" class="hidden">
      <div class="success-icon">âœ…</div>
      <div class="message success">
        <div id="successMessage"></div>
      </div>
      
      <div class="device-info">
        <strong>å·¥è™Ÿï¼š</strong><span id="displayEmployeeId">-</span><br>
        <strong>å§“åï¼š</strong><span id="displayEmployeeName">-</span><br>
        <strong>ç«™åˆ¥ï¼š</strong><span id="displayStation">-</span><br>
        <strong>æ™‚é–“ï¼š</strong><span id="displayTime">-</span>
      </div>
    </div>
    
    <!-- éŒ¯èª¤è¨Šæ¯ -->
    <div id="errorMessage" class="message error hidden"></div>
  </div>

  <script>
    // ============================================
    // å…¨åŸŸè®Šæ•¸
    // ============================================
    let deviceId = '';
    let stationName = '<?= station ?>';
    
    // ============================================
    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    // ============================================
    window.onload = function() {
      // é¡¯ç¤ºç«™åˆ¥åç¨±
      if (stationName) {
        document.getElementById('stationName').textContent = stationName;
      } else {
        document.getElementById('stationName').textContent = 'æœªæŒ‡å®šç«™åˆ¥';
        showError('éŒ¯èª¤ï¼šæœªæŒ‡å®šç«™åˆ¥ï¼Œè«‹æƒææ­£ç¢ºçš„QR Code');
        return;
      }
      
      // ç”Ÿæˆè£ç½®ID
      deviceId = generateDeviceId();
      document.getElementById('deviceIdDisplay').textContent = deviceId.substring(0, 16) + '...';
      
      // æª¢æŸ¥è£ç½®ç¶å®šç‹€æ…‹
      checkDevice();
    };
    
    // ============================================
    // ç”Ÿæˆè£ç½®å”¯ä¸€è­˜åˆ¥ç¢¼
    // ============================================
    function generateDeviceId() {
      // å˜—è©¦å¾localStorageå–å¾—å·²å„²å­˜çš„ID
      let storedId = localStorage.getItem('factoryDeviceId');
      if (storedId) {
        return storedId;
      }
      
      // æ”¶é›†è£ç½®æŒ‡ç´‹è³‡è¨Š
      let fingerprint = {
        userAgent: navigator.userAgent,
        language: navigator.language,
        platform: navigator.platform,
        screenResolution: screen.width + 'x' + screen.height,
        colorDepth: screen.colorDepth,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        timestamp: Date.now(),
        random: Math.random().toString(36)
      };
      
      // è½‰æ›ç‚ºJSONå­—ä¸²ä¸¦ç”Ÿæˆhash
      let fingerprintString = JSON.stringify(fingerprint);
      let hash = simpleHash(fingerprintString);
      
      // å„²å­˜åˆ°localStorage
      localStorage.setItem('factoryDeviceId', hash);
      
      return hash;
    }
    
    // ============================================
    // ç°¡æ˜“Hashå‡½å¼
    // ============================================
    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        let char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return 'DEV_' + Math.abs(hash).toString(36) + '_' + Date.now().toString(36);
    }
    
    // ============================================
    // æª¢æŸ¥è£ç½®ç¶å®šç‹€æ…‹
    // ============================================
    function checkDevice() {
      fetch(window.location.href + '&action=checkDevice&deviceId=' + encodeURIComponent(deviceId))
        .then(response => response.json())
        .then(data => {
          document.getElementById('loadingScreen').classList.add('hidden');
          
          if (data.success && data.isBound) {
            // å·²ç¶å®šï¼Œç›´æ¥æ‰“å¡
            performCheckin(data.employeeId, data.employeeName);
          } else if (data.success && !data.isBound) {
            // æœªç¶å®šï¼Œé¡¯ç¤ºç¶å®šè¡¨å–®
            document.getElementById('bindingForm').classList.remove('hidden');
          } else {
            // éŒ¯èª¤
            showError(data.message || 'ç³»çµ±éŒ¯èª¤');
          }
        })
        .catch(error => {
          document.getElementById('loadingScreen').classList.add('hidden');
          showError('ç¶²è·¯éŒ¯èª¤ï¼š' + error.message);
        });
    }
    
    // ============================================
    // è™•ç†ç¶å®š
    // ============================================
    function handleBind() {
      let employeeId = document.getElementById('employeeId').value.trim();
      let employeeName = document.getElementById('employeeName').value.trim();
      
      if (!employeeId) {
        alert('è«‹è¼¸å…¥å·¥è™Ÿ');
        return;
      }
      
      if (!employeeName) {
        alert('è«‹è¼¸å…¥å§“å');
        return;
      }
      
      // ç¦ç”¨æŒ‰éˆ•
      let btn = event.target;
      btn.disabled = true;
      btn.textContent = 'ç¶å®šä¸­...';
      
      // ç™¼é€ç¶å®šè«‹æ±‚
      let url = window.location.href + 
                '&action=bindDevice' +
                '&deviceId=' + encodeURIComponent(deviceId) +
                '&employeeId=' + encodeURIComponent(employeeId) +
                '&employeeName=' + encodeURIComponent(employeeName);
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // ç¶å®šæˆåŠŸï¼Œç¹¼çºŒæ‰“å¡
            performCheckin(data.employeeId, data.employeeName);
          } else {
            // ç¶å®šå¤±æ•—
            btn.disabled = false;
            btn.textContent = 'ç¶å®šä¸¦æ‰“å¡';
            showError(data.message);
          }
        })
        .catch(error => {
          btn.disabled = false;
          btn.textContent = 'ç¶å®šä¸¦æ‰“å¡';
          showError('ç¶²è·¯éŒ¯èª¤ï¼š' + error.message);
        });
    }
    
    // ============================================
    // åŸ·è¡Œæ‰“å¡
    // ============================================
    function performCheckin(employeeId, employeeName) {
      let url = window.location.href + 
                '&action=checkin' +
                '&deviceId=' + encodeURIComponent(deviceId) +
                '&station=' + encodeURIComponent(stationName);
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // æ‰“å¡æˆåŠŸ
            document.getElementById('bindingForm').classList.add('hidden');
            document.getElementById('successMessage').innerHTML = 
              '<strong>âœ… æ‰“å¡æˆåŠŸï¼</strong><br>' + data.message;
            document.getElementById('displayEmployeeId').textContent = data.employeeId;
            document.getElementById('displayEmployeeName').textContent = data.employeeName;
            document.getElementById('displayStation').textContent = data.station;
            document.getElementById('displayTime').textContent = data.time;
            document.getElementById('checkinSuccess').classList.remove('hidden');
          } else {
            showError(data.message);
          }
        })
        .catch(error => {
          showError('ç¶²è·¯éŒ¯èª¤ï¼š' + error.message);
        });
    }
    
    // ============================================
    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    // ============================================
    function showError(message) {
      let errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = 'âŒ ' + message;
      errorDiv.classList.remove('hidden');
    }
  </script>
</body>
</html>
